<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Comparium</title>
    <meta name="description" content="Your Comparium dashboard - view your saved comparisons, tanks, and favorite fish.">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/enhanced-ui.css">
    <link rel="stylesheet" href="css/ocean-theme.css">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8VNY458QF3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8VNY458QF3');
    </script>
</head>
<body>
    <div class="header">
        <h1>üê† Comparium</h1>
        <p>Fish Species Compatibility Tool</p>
        <div class="header-nav">
            <a href="index.html">Compare Fish</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="my-tanks.html">My Tanks</a>
            <a href="glossary.html">Glossary</a>
            <div id="auth-links"></div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Welcome back, <span id="username-display"></span>!</h1>
            <p>Manage your fish comparisons, tanks, and favorites</p>
        </div>

        <!-- Stats Cards -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <span class="stat-number" id="comparison-count">0</span>
                <span class="stat-label">Comparisons Saved</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="tank-count">0</span>
                <span class="stat-label">Tanks Created</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="favorite-count">0</span>
                <span class="stat-label">Favorite Species</span>
            </div>
        </div>

        <!-- Recent Comparisons -->
        <div class="dashboard-section">
            <h2>üìä Recent Comparisons</h2>
            <div id="recent-comparisons">
                <div class="empty-state-small">
                    <p>No comparisons yet. <a href="index.html">Start comparing fish!</a></p>
                </div>
            </div>
        </div>

        <!-- My Tanks -->
        <div class="dashboard-section">
            <h2>üè† My Tanks</h2>
            <div id="my-tanks-preview">
                <div class="empty-state-small">
                    <p>No tanks created yet. <a href="my-tanks.html">Create your first tank!</a></p>
                </div>
            </div>
            <p style="text-align: center; margin-top: 1rem;">
                <a href="my-tanks.html" class="btn-small">Manage All Tanks</a>
            </p>
        </div>

        <!-- Favorite Species -->
        <div class="dashboard-section">
            <h2>‚≠ê Favorite Species</h2>
            <div id="favorite-species">
                <div class="empty-state-small">
                    <p>No favorites yet. Click the ‚òÖ on species when comparing to save them!</p>
                </div>
            </div>
        </div>

        <!-- Export Data -->
        <div class="dashboard-section">
            <h2>üíæ Data Management</h2>
            <p>Export your data to back it up or transfer to another device.</p>
            <button onclick="exportData()" class="btn-small">Export My Data (JSON)</button>
        </div>
    </div>

    <div class="footer">
    <p>&copy; <span id="copyright-year"></span> Comparium. </p>
    <p><a href="about.html">About</a> | <a href="mailto:contact@comparium.net">Contact</a></p>
    </div>

    <script src="js/fish-data.js"></script>
    <script src="js/storage-service.js"></script>
    <script src="js/auth-manager.js"></script>
    <script>
        // Require authentication
        if (!authManager.requireAuth()) {
            // Will redirect to login
        } else {
            loadDashboard();
        }

        async function loadDashboard() {
            const username = authManager.getCurrentUsername();
            document.getElementById('username-display').textContent = username;

            // Load profile data
            const profile = await storageService.getUserProfile(username);
            
            if (profile) {
                // Update stats
                const comparisons = profile.profile.comparisonHistory || [];
                const tanks = profile.profile.tanks || [];
                const favorites = profile.profile.favoriteSpecies || [];

                document.getElementById('comparison-count').textContent = comparisons.length;
                document.getElementById('tank-count').textContent = tanks.length;
                document.getElementById('favorite-count').textContent = favorites.length;

                // Load recent comparisons
                loadRecentComparisons(comparisons.slice(0, 5));

                // Load tank preview
                loadTanksPreview(tanks.slice(0, 3));

                // Load favorites
                loadFavorites(favorites);
            }
        }

        function loadRecentComparisons(comparisons) {
            const container = document.getElementById('recent-comparisons');
            
            if (comparisons.length === 0) {
                return; // Keep empty state
            }

            let html = '<ul class="item-list">';
            comparisons.forEach(comp => {
                const speciesNames = comp.species.map(s => s.name).join(', ');
                const date = new Date(comp.date).toLocaleDateString();
                const icon = comp.compatible ? '‚úÖ' : '‚ö†Ô∏è';
                
                html += `
                    <li>
                        <div>
                            <strong>${icon} ${speciesNames}</strong><br>
                            <small>${date}</small>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            
            container.innerHTML = html;
        }

        function loadTanksPreview(tanks) {
            const container = document.getElementById('my-tanks-preview');
            
            if (tanks.length === 0) {
                return; // Keep empty state
            }

            let html = '';
            tanks.forEach(tank => {
                const speciesCount = tank.species ? tank.species.length : 0;
                html += `
                    <div class="tank-card" onclick="window.location.href='my-tanks.html'">
                        <h3>${tank.name}</h3>
                        <div class="tank-card-meta">
                            ${tank.size} gallons ‚Ä¢ ${speciesCount} species
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function loadFavorites(favorites) {
            const container = document.getElementById('favorite-species');
            
            if (favorites.length === 0) {
                return; // Keep empty state
            }

            let html = '<ul class="item-list">';
            favorites.forEach(speciesKey => {
                const fish = fishDatabase[speciesKey];
                if (fish) {
                    html += `
                        <li>
                            <div>
                                <strong>${fish.commonName}</strong><br>
                                <small><em>${fish.scientificName}</em></small>
                            </div>
                            <span class="favorite-star active" onclick="removeFavorite('${speciesKey}')">‚òÖ</span>
                        </li>
                    `;
                }
            });
            html += '</ul>';
            
            container.innerHTML = html;
        }

        async function removeFavorite(speciesKey) {
            const username = authManager.getCurrentUsername();
            await storageService.removeFavorite(username, speciesKey);
            authManager.showMessage('Removed from favorites', 'success');
            loadDashboard(); // Reload to update display
        }

        async function exportData() {
            const username = authManager.getCurrentUsername();
            const data = await storageService.exportUserData(username);
            
            if (data) {
                // Create download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Comparium-${username}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                authManager.showMessage('Data exported successfully', 'success');
            }
        }
    </script>
    <!-- Auto-update copyright year -->
    <script>
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>

    <script type="module" src="js/firebase-init.js"></script>
    <script src="js/theme-manager.js"></script>
    <script>
      // Prefer using authManager to enforce login and display username/email
      if (!authManager.requireAuth()) {
          // requireAuth will redirect to login
      } else {
          const displayName = authManager.getCurrentUsername() || 'Guest';
          const header = document.querySelector('.dashboard-header h1');
          if (header) header.textContent = 'Welcome back, ' + displayName + '!';
      }
    </script>
</body>
</html>
