<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Comparium</title>
    <meta
      name="description"
      content="Your Comparium dashboard - view your saved comparisons, tanks, and favorite fish."
    />
    <meta name="author" content="Comparium" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/naturalist.css" />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8VNY458QF3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-8VNY458QF3');
    </script>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <a href="index.html" class="logo">Comparium</a>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="compare.html">Compare</a>
        <a href="glossary.html">Glossary</a>
        <a href="faq.html">FAQ</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <div id="auth-links"></div>
      </nav>
    </header>

    <div class="dashboard-container">
      <div class="dashboard-header">
        <div class="dashboard-header-text">
          <h1>Welcome back, <span id="username-display"></span></h1>
          <p>Manage your fish comparisons, tanks, and favorites</p>
        </div>
        <div class="dashboard-header-actions">
          <!-- Notification Bell -->
          <div class="notification-wrapper">
            <button
              id="notification-toggle"
              class="icon-btn"
              onclick="toggleNotifications()"
              aria-label="Notifications"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              <span id="notification-badge" class="notification-badge">0</span>
            </button>
            <div id="notification-dropdown" class="header-dropdown notification-dropdown">
              <div class="dropdown-header">
                <h3>Notifications</h3>
                <button onclick="markAllRead()" class="dropdown-action">Mark all read</button>
              </div>
              <div id="notification-list" class="notification-list">
                <div class="notification-empty">
                  <p>No notifications yet</p>
                  <small>Maintenance reminders will appear here</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Gear -->
          <div class="settings-wrapper">
            <button
              id="settings-toggle"
              class="icon-btn"
              onclick="toggleSettings()"
              aria-label="Settings"
            >
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                ></path>
              </svg>
            </button>
            <div id="settings-dropdown" class="header-dropdown settings-dropdown">
              <div class="dropdown-header">
                <h3>Settings</h3>
              </div>
              <div class="settings-dropdown-content">
                <div class="settings-dropdown-item">
                  <span class="settings-label">Account</span>
                  <span class="settings-value" id="settings-username"></span>
                </div>
                <div class="settings-dropdown-divider"></div>
                <button onclick="authManager.logout()" class="settings-dropdown-btn">
                  Log Out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <span class="stat-number" id="comparison-count">0</span>
          <span class="stat-label">Comparisons Saved</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="tank-count">0</span>
          <span class="stat-label">Tanks Created</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="favorite-count">0</span>
          <span class="stat-label">Favorite Species</span>
        </div>
      </div>

      <!-- Recent Comparisons -->
      <div class="dashboard-section">
        <h2>Recent Comparisons</h2>
        <div id="recent-comparisons">
          <div class="empty-state-small">
            <p>No comparisons yet. <a href="compare.html">Start comparing fish!</a></p>
          </div>
        </div>
      </div>

      <!-- My Tanks - Full Management -->
      <div class="dashboard-section" id="my-tanks-section">
        <div class="dashboard-section-header">
          <h2>My Tanks</h2>
          <button onclick="showNewTankForm()" class="btn btn-primary">+ Create New Tank</button>
        </div>

        <!-- Tank Form (Initially Hidden) -->
        <div id="tank-form-container" class="tank-form" style="display: none">
          <h3 id="form-title">Create New Tank</h3>
          <form id="tank-form" onsubmit="saveTank(event)">
            <input type="hidden" id="tank-id" />

            <div class="form-group">
              <label for="tank-name">Tank Name</label>
              <input type="text" id="tank-name" required placeholder="e.g., Living Room 55g" />
            </div>

            <div class="form-group">
              <label for="tank-size">Tank Size (gallons)</label>
              <input type="number" id="tank-size" required min="1" placeholder="e.g., 55" />
            </div>

            <div class="form-group">
              <label for="tank-notes">Notes (Optional)</label>
              <textarea
                id="tank-notes"
                rows="3"
                placeholder="Equipment, substrate, plans..."
              ></textarea>
            </div>

            <div class="form-group">
              <label>Select Fish Species</label>
              <input
                type="text"
                id="species-search"
                placeholder="Search species..."
                oninput="filterSpeciesSelector()"
              />
              <select id="species-selector" onchange="addSpeciesToTank()" size="6">
                <option value="">-- Choose a species to add --</option>
              </select>
              <small class="form-hint">Type to filter, click to add</small>
            </div>

            <div id="selected-species-list" class="selected-species">
              <strong>Selected Species:</strong>
              <ul id="species-list" class="fish-list"></ul>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Save Tank</button>
              <button type="button" onclick="cancelForm()" class="btn btn-ghost">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Tanks List -->
        <div id="tanks-container">
          <div class="loading-state">
            <p>Loading tanks...</p>
          </div>
        </div>
      </div>

      <!-- Favorite Species -->
      <div class="dashboard-section">
        <h2>Favorite Species</h2>
        <div id="favorite-species">
          <div class="empty-state-small">
            <p>No favorites yet. Click the star on species when comparing to save them!</p>
          </div>
        </div>
      </div>

      <!-- Export Data -->
      <div class="dashboard-section">
        <h2>Data Management</h2>
        <p>Export your data to back it up or transfer to another device.</p>
        <button onclick="exportData()" class="btn btn-ghost">Export My Data (JSON)</button>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-logo">Comparium</div>
      <div class="footer-links">
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="glossary.html">Glossary</a>
      </div>
      <p class="footer-copy">&copy; <span id="copyright-year"></span> Comparium</p>
    </footer>

    <!-- Auto-update copyright year -->
    <script>
      document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>

    <!-- Scripts -->
    <script type="module" src="js/firebase-init.js"></script>
    <script src="js/storage-service.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/fish-data.js"></script>
    <script src="js/tank-manager.js"></script>
    <script src="js/maintenance-manager.js"></script>
    <script>
      // PRODUCTION: Proper auth check using Firebase's event system
      (async () => {
        try {
          // Wait for Firebase to initialize with timeout
          const firebaseTimeout = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Firebase initialization timeout')), 10000)
          );

          // Wait for firebaseAuthReady to be defined
          let attempts = 0;
          while (!window.firebaseAuthReady && attempts < 200) {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
          }

          if (!window.firebaseAuthReady) {
            throw new Error('Firebase failed to initialize');
          }

          // Wait for Firebase Auth to complete its initial state check or timeout
          const user = await Promise.race([window.firebaseAuthReady, firebaseTimeout]);

          if (!user) {
            // Not authenticated - redirect to login
            console.log('Not authenticated, redirecting to login');
            window.location.href = 'login.html';
            return;
          }

          // User is authenticated - load dashboard
          await loadDashboard(user);
        } catch (error) {
          console.error('Dashboard initialization error:', error);
          showErrorState(
            'Unable to load dashboard. Please check your connection and <a href="javascript:location.reload()">refresh the page</a>.'
          );
        }
      })();

      function showErrorState(message) {
        const container = document.querySelector('.dashboard-container');
        if (container) {
          container.innerHTML = `
                    <div class="dashboard-section" style="text-align: center; padding: 3rem;">
                        <h2 style="color: #dc3545;">Error Loading Dashboard</h2>
                        <p style="margin: 1rem 0;">${message}</p>
                        <p style="margin-top: 2rem;">
                            <a href="login.html" class="btn btn-primary">Return to Login</a>
                        </p>
                    </div>
                `;
        }
      }

      async function loadDashboard(user) {
        try {
          // Load profile
          const profile = await window.firestoreGetProfile(user.uid);

          if (!profile) {
            console.error('Profile not found');
            window.location.href = 'login.html';
            return;
          }

          // Display username in header and settings
          const username = profile.username || 'User';
          document.getElementById('username-display').textContent = username;
          document.getElementById('settings-username').textContent = username;

          if (profile) {
            // Update stats
            const comparisons = profile.profile.comparisonHistory || [];
            const tanks = profile.profile.tanks || [];
            const favorites = profile.profile.favoriteSpecies || [];

            document.getElementById('comparison-count').textContent = comparisons.length;
            document.getElementById('tank-count').textContent = tanks.length;
            document.getElementById('favorite-count').textContent = favorites.length;

            // Load recent comparisons
            loadRecentComparisons(comparisons.slice(0, 5));

            // Initialize tank manager (loads full tank list)
            await window.tankManager.init();

            // Load favorites
            loadFavorites(favorites);
          }
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          showErrorState(
            'Failed to load your data. Please <a href="javascript:location.reload()">refresh the page</a>.'
          );
        }
      }

      function loadRecentComparisons(comparisons) {
        const container = document.getElementById('recent-comparisons');

        if (comparisons.length === 0) {
          return; // Keep empty state
        }

        let html = '<ul class="item-list">';
        comparisons.forEach(comp => {
          const speciesNames = comp.species.map(s => s.name).join(', ');
          const speciesKeys = comp.species.map(s => s.key).join(',');
          const compareUrl = `compare.html?species=${encodeURIComponent(speciesKeys)}`;
          const date = new Date(comp.date).toLocaleDateString();
          const icon = comp.compatible ? '&#10003;' : '&#9888;';

          html += `
                    <li>
                        <a href="${compareUrl}" class="item-link">
                            <strong>${icon} ${speciesNames}</strong><br>
                            <small>${date}</small>
                        </a>
                    </li>
                `;
        });
        html += '</ul>';

        container.innerHTML = html;
      }

      function loadFavorites(favorites) {
        const container = document.getElementById('favorite-species');

        if (favorites.length === 0) {
          return; // Keep empty state
        }

        let html = '<ul class="item-list">';
        favorites.forEach(speciesKey => {
          const fish = fishDatabase[speciesKey];
          if (fish) {
            // Use encodeURIComponent for URL and data-species for click handler (XSS-safe)
            html += `
                        <li>
                            <a href="species.html?fish=${encodeURIComponent(speciesKey)}" class="item-link">
                                <strong>${fish.commonName}</strong><br>
                                <small><em>${fish.scientificName}</em></small>
                            </a>
                            <span class="favorite-star active" data-species="${speciesKey}">&#9733;</span>
                        </li>
                    `;
          }
        });
        html += '</ul>';

        container.innerHTML = html;
      }

      // Delegated click handler for favorite stars (XSS-safe alternative to inline onclick)
      document.getElementById('favorite-species').addEventListener('click', function (event) {
        const star = event.target.closest('.favorite-star');
        if (star && star.dataset.species) {
          removeFavorite(star.dataset.species);
        }
      });

      async function removeFavorite(speciesKey) {
        const uid = authManager.getCurrentUid();
        await storageService.removeFavorite(uid, speciesKey);
        authManager.showMessage('Removed from favorites', 'success');
        loadDashboard(); // Reload to update display
      }

      async function exportData() {
        const uid = authManager.getCurrentUid();
        const data = await storageService.exportUserData(uid);

        if (data) {
          // Create download
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Comparium-${username}-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          authManager.showMessage('Data exported successfully', 'success');
        }
      }

      // ============================================
      // Dropdown Functions (Notifications & Settings)
      // ============================================

      function toggleNotifications() {
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');
        // Close settings if open
        settingsDropdown.classList.remove('open');
        // Toggle notifications
        notifDropdown.classList.toggle('open');
      }

      function toggleSettings() {
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');
        // Close notifications if open
        notifDropdown.classList.remove('open');
        // Toggle settings
        settingsDropdown.classList.toggle('open');
      }

      function markAllRead() {
        // Future: Update Firestore to mark all as read
        // For now, just close the dropdown
        const dropdown = document.getElementById('notification-dropdown');
        dropdown.classList.remove('open');
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function (event) {
        const notifWrapper = document.querySelector('.notification-wrapper');
        const settingsWrapper = document.querySelector('.settings-wrapper');
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');

        // Close notification dropdown if clicking outside
        if (notifWrapper && notifDropdown && !notifWrapper.contains(event.target)) {
          notifDropdown.classList.remove('open');
        }

        // Close settings dropdown if clicking outside
        if (settingsWrapper && settingsDropdown && !settingsWrapper.contains(event.target)) {
          settingsDropdown.classList.remove('open');
        }
      });

      // Update notification badge count
      function updateNotificationBadge(count) {
        const badge = document.getElementById('notification-badge');
        if (badge) {
          badge.textContent = count;
          badge.setAttribute('data-count', count);
          badge.style.display = count > 0 ? 'flex' : 'none';
        }
      }

      // Render notifications list
      function renderNotifications(notifications) {
        const list = document.getElementById('notification-list');

        if (!notifications || notifications.length === 0) {
          list.innerHTML = `
            <div class="notification-empty">
              <p>No notifications yet</p>
              <small>Maintenance reminders will appear here</small>
            </div>
          `;
          updateNotificationBadge(0);
          return;
        }

        const unreadCount = notifications.filter(n => !n.read).length;
        updateNotificationBadge(unreadCount);

        list.innerHTML = notifications
          .map(
            n => `
          <div class="notification-item ${n.read ? '' : 'unread'}" data-id="${n.id}">
            <div class="notification-item-title">${n.title}</div>
            <div class="notification-item-body">${n.body}</div>
            <div class="notification-item-time">${formatTimeAgo(n.created)}</div>
          </div>
        `
          )
          .join('');
      }

      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }

      // Initialize with empty state (Phase 2 will add Firestore loading)
      updateNotificationBadge(0);
    </script>
  </body>
</html>
