<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Comparium</title>
    <meta
      name="description"
      content="Your Comparium dashboard - view your saved comparisons, tanks, and favorite fish."
    />
    <meta name="author" content="Comparium" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/naturalist.css" />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8VNY458QF3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-8VNY458QF3');
    </script>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <a href="index.html" class="logo">Comparium</a>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="compare.html">Compare</a>
        <a href="glossary.html">Glossary</a>
        <a href="community.html">Community</a>
        <a href="faq.html">FAQ</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <div id="auth-links"></div>
      </nav>
    </header>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
      <!-- Dashboard Hero Section -->
      <section class="dashboard-hero dashboard-section-animate">
        <div class="dashboard-hero-ambient"></div>
        <div class="dashboard-hero-content">
          <!-- Actions (Notifications + Settings) - positioned absolute -->
          <div class="dashboard-header-actions">
            <!-- Notification Bell -->
            <div class="notification-wrapper">
              <button
                id="notification-toggle"
                class="icon-btn"
                onclick="toggleNotifications()"
                aria-label="Notifications"
              >
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span id="notification-badge" class="notification-badge">0</span>
              </button>
              <div id="notification-dropdown" class="header-dropdown notification-dropdown">
                <div class="dropdown-header">
                  <h3>Notifications</h3>
                  <button onclick="markAllRead()" class="dropdown-action">Mark all read</button>
                </div>
                <div id="notification-list" class="notification-list">
                  <div class="notification-empty">
                    <p>No notifications yet</p>
                    <small>Maintenance reminders will appear here</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Gear -->
            <div class="settings-wrapper">
              <button
                id="settings-toggle"
                class="icon-btn"
                onclick="toggleSettings()"
                aria-label="Settings"
              >
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="3"></circle>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  ></path>
                </svg>
              </button>
              <div id="settings-dropdown" class="header-dropdown settings-dropdown">
                <div class="dropdown-header">
                  <h3>Settings</h3>
                </div>
                <div class="settings-dropdown-content">
                  <div class="settings-dropdown-item">
                    <span class="settings-label">Account</span>
                    <span class="settings-value" id="settings-username"></span>
                  </div>
                  <div class="settings-dropdown-divider"></div>
                  <div class="settings-dropdown-item" id="push-notification-setting">
                    <span class="settings-label">Push Notifications</span>
                    <button
                      id="push-toggle-btn"
                      class="settings-toggle-btn"
                      onclick="togglePushNotifications()"
                    >
                      Enable
                    </button>
                  </div>
                  <div class="settings-dropdown-divider"></div>
                  <button onclick="viewMyProfile()" class="settings-dropdown-btn">
                    View My Profile
                  </button>
                  <div class="settings-dropdown-divider"></div>
                  <button onclick="authManager.logout()" class="settings-dropdown-btn">
                    Log Out
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Greeting -->
          <h1 class="dashboard-greeting">
            <span id="greeting-time">Good evening</span>,
            <span class="username" id="username-display"></span>
          </h1>
          <p class="dashboard-status" id="dashboard-status">Your aquariums are looking great</p>

          <!-- Integrated Stats -->
          <div class="dashboard-hero-stats">
            <span class="hero-stat"><span id="tank-count">0</span> tanks</span>
            <span class="hero-stat-divider">·</span>
            <span class="hero-stat"><span id="species-total-count">0</span> species</span>
            <span class="hero-stat-divider">·</span>
            <span class="hero-stat"><span id="favorite-count">0</span> favorites</span>
            <span class="hero-stat-divider">·</span>
            <span class="hero-stat"><span id="follower-count">0</span> followers</span>
            <span class="hero-stat-divider">·</span>
            <span class="hero-stat"><span id="following-count">0</span> following</span>
          </div>

          <!-- Hero Actions -->
          <div class="dashboard-hero-actions">
            <button onclick="showNewTankForm()" class="btn btn-primary" id="hero-cta-btn">
              + Add New Tank
            </button>
          </div>

          <!-- Hidden element for comparison count (used by JS) -->
          <span id="comparison-count" style="display: none">0</span>
        </div>
      </section>

      <!-- Dashboard Tabs -->
      <nav class="dashboard-tabs">
        <button class="dashboard-tab active" data-tab="tanks" onclick="switchDashboardTab('tanks')">
          My Tanks
        </button>
        <button class="dashboard-tab" data-tab="profile" onclick="switchDashboardTab('profile')">
          My Profile
        </button>
        <button class="dashboard-tab" data-tab="settings" onclick="switchDashboardTab('settings')">
          Settings
        </button>
      </nav>

      <!-- Tab Content Container -->
      <div class="dashboard-tab-content">
        <!-- My Tanks Tab -->
        <div id="tab-tanks" class="dashboard-tab-panel active">
          <!-- Main Row: Tanks + Maintenance -->
          <div class="dashboard-main-row">
            <!-- Tank Gallery Section -->
            <section class="tank-gallery-section dashboard-section-animate" id="my-tanks-section">
          <div class="tank-gallery-header">
            <h2>My Tanks</h2>
          </div>

          <!-- Tank Form (Initially Hidden) -->
          <div id="tank-form-container" class="tank-form" style="display: none">
            <h3 id="form-title">Create New Tank</h3>
            <form id="tank-form" onsubmit="saveTank(event)">
              <input type="hidden" id="tank-id" />

              <div class="form-group">
                <label for="tank-name">Tank Name</label>
                <input type="text" id="tank-name" required placeholder="e.g., Living Room 55g" />
              </div>

              <div class="form-group">
                <label for="tank-size">Tank Size (gallons)</label>
                <input type="number" id="tank-size" required min="1" placeholder="e.g., 55" />
              </div>

              <div class="form-group">
                <label for="tank-notes">Notes (Optional)</label>
                <textarea
                  id="tank-notes"
                  rows="3"
                  placeholder="Equipment, substrate, plans..."
                ></textarea>
              </div>

              <div class="form-group">
                <label for="tank-photo">Tank Photo (Optional)</label>
                <div class="photo-upload-zone" id="photo-upload-zone">
                  <input
                    type="file"
                    id="tank-photo"
                    accept="image/jpeg,image/png,image/webp"
                    onchange="handlePhotoSelect(event)"
                    style="display: none"
                  />
                  <div class="photo-upload-placeholder" id="photo-upload-placeholder">
                    <span class="photo-upload-icon">+</span>
                    <span>Click or drag to add a photo</span>
                    <small>JPEG, PNG, or WebP (max 5MB)</small>
                  </div>
                  <div class="photo-upload-preview" id="photo-upload-preview" style="display: none">
                    <img id="photo-preview-image" src="" alt="Tank photo preview" />
                    <button type="button" class="photo-remove-btn" onclick="removePhotoSelection()">
                      Remove
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>Select Fish Species</label>
                <input
                  type="text"
                  id="species-search"
                  placeholder="Search species..."
                  oninput="filterSpeciesSelector()"
                />
                <select id="species-selector" onchange="addSpeciesToTank()" size="6">
                  <option value="">-- Choose a species to add --</option>
                </select>
                <small class="form-hint">Type to filter, click to add</small>
              </div>

              <div id="selected-species-list" class="selected-species">
                <strong>Selected Species:</strong>
                <ul id="species-list" class="fish-list"></ul>
              </div>

              <!-- Plant Selector -->
              <div class="form-group">
                <label>Add Plants (Optional)</label>
                <input
                  type="text"
                  id="plant-search"
                  placeholder="Search plants..."
                  oninput="filterPlantSelector()"
                />
                <select id="plant-selector" onchange="addPlantToTank()" size="5">
                  <option value="">-- Choose a plant to add --</option>
                </select>
                <small class="form-hint">Type to filter, click to add</small>
              </div>

              <div id="selected-plants-list" class="selected-plants">
                <strong>Selected Plants:</strong>
                <ul id="plants-list" class="plant-list"></ul>
              </div>

              <!-- Share Tank Public/Private -->
              <div class="form-group share-toggle-group">
                <input type="hidden" id="tank-public" value="false" />
                <div class="privacy-selector">
                  <div class="privacy-buttons">
                    <button type="button" class="privacy-btn" data-value="true">Yes</button>
                    <button type="button" class="privacy-btn selected" data-value="false">
                      No
                    </button>
                  </div>
                  <span class="privacy-label">Share this tank publicly</span>
                </div>
                <small class="form-hint">Public tanks appear in the Community gallery</small>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Tank</button>
                <button type="button" onclick="cancelForm()" class="btn btn-ghost">Cancel</button>
              </div>
            </form>
          </div>

          <!-- Tank Gallery (populated by JS) -->
          <div id="tanks-container" class="tank-gallery">
            <div class="tank-gallery-empty">
              <p>Loading tanks...</p>
            </div>
          </div>
        </section>

        <!-- Maintenance Timeline Section -->
        <section class="maintenance-timeline-section dashboard-section-animate">
          <div class="maintenance-timeline-header">
            <h2>Upcoming Care</h2>
            <span class="maintenance-timeline-summary" id="maintenance-summary"></span>
          </div>

          <!-- Maintenance Timeline (populated by JS) -->
          <div id="maintenance-timeline">
            <div class="maintenance-timeline-empty">
              <p>No maintenance scheduled</p>
            </div>
          </div>

          <!-- Actions Section -->
          <div class="timeline-actions" id="timeline-actions" style="display: none">
            <button class="btn btn-primary" id="timeline-log-event-btn">+ Log Event</button>
            <button class="btn btn-ghost" id="timeline-add-schedule-btn">+ Add Schedule</button>
          </div>
            </section>
          </div>
        </div>
        <!-- End My Tanks Tab -->

        <!-- My Profile Tab -->
        <div id="tab-profile" class="dashboard-tab-panel" style="display: none;">
          <!-- Profile Sub-tabs -->
          <nav class="dashboard-subtabs">
            <button class="dashboard-subtab active" data-subtab="overview" onclick="switchProfileSubtab('overview')">
              Overview
            </button>
            <button class="dashboard-subtab" data-subtab="posts" onclick="switchProfileSubtab('posts')">
              My Posts
            </button>
            <button class="dashboard-subtab" data-subtab="bookmarks" onclick="switchProfileSubtab('bookmarks')">
              Bookmarks
            </button>
          </nav>

          <!-- Overview Sub-tab -->
          <div id="subtab-overview" class="dashboard-subtab-panel active">
            <div class="profile-card">
              <div class="profile-card__avatar">
                <span id="profile-avatar-letter">U</span>
              </div>
              <div class="profile-card__info">
                <h2 id="profile-card-username">@username</h2>
                <p id="profile-card-details" class="profile-card__details">
                  <!-- Experience · Location -->
                </p>
                <p id="profile-card-bio" class="profile-card__bio">
                  <!-- Bio text -->
                </p>
                <div id="profile-card-stats" class="profile-card__stats">
                  <span><strong id="profile-post-count">0</strong> posts</span>
                  <span><strong id="profile-follower-count">0</strong> followers</span>
                  <span><strong id="profile-following-count">0</strong> following</span>
                </div>
                <div class="profile-card__actions">
                  <button class="btn btn-primary" onclick="openProfileEditModal()">Edit Profile</button>
                  <button class="btn btn-ghost" onclick="viewMyProfile()">View Public Profile</button>
                </div>
              </div>
            </div>
          </div>

          <!-- My Posts Sub-tab -->
          <div id="subtab-posts" class="dashboard-subtab-panel" style="display: none;">
            <div id="my-posts-list" class="my-posts-list">
              <p>Loading your posts...</p>
            </div>
          </div>

          <!-- Bookmarks Sub-tab -->
          <div id="subtab-bookmarks" class="dashboard-subtab-panel" style="display: none;">
            <div id="my-bookmarks-list" class="my-bookmarks-list">
              <p>Loading bookmarks...</p>
            </div>
          </div>
        </div>
        <!-- End My Profile Tab -->

        <!-- Settings Tab -->
        <div id="tab-settings" class="dashboard-tab-panel" style="display: none;">
          <div class="settings-section">
            <h3>Notification Preferences</h3>
            <p class="settings-description">Control what appears in your notification bell.</p>

            <div class="settings-checkboxes">
              <label class="settings-checkbox">
                <input type="checkbox" id="pref-onComment" checked>
                <span>Someone comments on my post</span>
              </label>
              <label class="settings-checkbox">
                <input type="checkbox" id="pref-onReply" checked>
                <span>Someone replies to my comment</span>
              </label>
              <label class="settings-checkbox">
                <input type="checkbox" id="pref-onLike">
                <span>Someone likes my post or comment</span>
              </label>
              <label class="settings-checkbox">
                <input type="checkbox" id="pref-onFollow" checked>
                <span>Someone follows me</span>
              </label>
              <label class="settings-checkbox">
                <input type="checkbox" id="pref-onFollowingPost">
                <span>Someone I follow creates a post</span>
              </label>
            </div>

            <button class="btn btn-primary" onclick="saveNotificationPreferences()">
              Save Preferences
            </button>
          </div>

          <div class="settings-section">
            <h3>Account</h3>
            <div class="settings-account">
              <div class="settings-row">
                <span class="settings-label">Email</span>
                <span id="settings-email" class="settings-value">user@example.com</span>
              </div>
              <div class="settings-row">
                <span class="settings-label">Password</span>
                <span class="settings-value">••••••••</span>
                <a href="forgot-password.html" class="btn btn-ghost btn-small">Change Password</a>
              </div>
            </div>
          </div>
        </div>
        <!-- End Settings Tab -->

      </div>
      <!-- End Tab Content Container -->
    </div>

    <!-- Tank Detail Modal -->
    <div class="tank-modal-backdrop" id="tank-modal-backdrop">
      <div class="tank-modal">
        <button class="tank-modal-close" onclick="closeTankModal()">&times;</button>
        <div class="tank-modal-header">
          <div class="tank-modal-mosaic" id="tank-modal-mosaic">
            <!-- Species images populated by JS -->
          </div>
        </div>
        <div class="tank-modal-body">
          <h2 class="tank-modal-name" id="tank-modal-name"></h2>
          <p class="tank-modal-meta" id="tank-modal-meta"></p>

          <div class="tank-modal-notes" id="tank-modal-notes" style="display: none"></div>

          <div class="tank-modal-section">
            <h3>Inhabitants</h3>
            <ul class="tank-modal-species-list" id="tank-modal-species"></ul>
          </div>

          <div class="tank-modal-section">
            <h3>Plants</h3>
            <ul class="tank-modal-species-list" id="tank-modal-plants"></ul>
          </div>

          <div class="tank-modal-section tank-modal-quicklog">
            <div class="section-header-with-action">
              <h3>Quick Log</h3>
              <button class="btn-small btn-text" id="tank-modal-log-event-btn">+ Log Event</button>
            </div>
            <div class="quick-log-buttons" id="tank-modal-quicklog-buttons">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="tank-modal-section">
            <div class="section-header-with-action">
              <h3>Maintenance Schedules</h3>
              <button class="btn-small btn-text" id="tank-modal-add-schedule-btn">
                + Add Schedule
              </button>
            </div>
            <div id="tank-modal-schedules">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="tank-modal-section">
            <h3>Recent Activity</h3>
            <div class="recent-events" id="tank-modal-events">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
        <div class="tank-modal-footer">
          <button class="btn btn-ghost" id="tank-modal-edit-btn">Edit Tank</button>
          <button class="btn btn-danger" id="tank-modal-delete-btn">Delete Tank</button>
        </div>
      </div>
    </div>

    <!-- Event/Schedule Modal Container (used by maintenance-manager.js) -->
    <div id="event-modal-container"></div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="modal-backdrop" style="display: none;">
      <div class="modal profile-edit-modal">
        <div class="modal-header">
          <h3>Edit Profile</h3>
          <button class="modal-close" onclick="closeProfileEditModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="edit-bio">Bio</label>
            <textarea id="edit-bio" rows="4" maxlength="500" placeholder="Tell others about yourself..."></textarea>
            <small class="form-hint"><span id="bio-char-count">0</span>/500 characters</small>
          </div>

          <div class="form-group">
            <label for="edit-experience">Experience Level</label>
            <select id="edit-experience">
              <option value="">Select your experience level</option>
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
              <option value="expert">Expert</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit-location">Location</label>
            <input type="text" id="edit-location" maxlength="100" placeholder="e.g., California, USA">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeProfileEditModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-logo">Comparium</div>
      <div class="footer-links">
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="glossary.html">Glossary</a>
        <a href="mailto:admin@comparium.net">Contact</a>
      </div>
      <p class="footer-copy">&copy; <span id="copyright-year"></span> Comparium</p>
    </footer>

    <!-- Auto-update copyright year -->
    <script>
      document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>

    <!-- Scripts -->
    <script type="module" src="js/firebase-init.js"></script>
    <script src="js/storage-service.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/fish-data.js"></script>
    <script src="js/plant-data.js"></script>
    <script src="js/public-tank-manager.js"></script>
    <script src="js/tank-manager.js"></script>
    <script src="js/maintenance-manager.js"></script>
    <script src="js/social-manager.js"></script>
    <script src="js/post-manager.js"></script>
    <script>
      // ============================================
      // Dashboard Initialization
      // ============================================

      (async () => {
        try {
          // Wait for Firebase to initialize with timeout
          const firebaseTimeout = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Firebase initialization timeout')), 10000)
          );

          // Wait for firebaseAuthReady to be defined
          let attempts = 0;
          while (!window.firebaseAuthReady && attempts < 200) {
            await new Promise(resolve => setTimeout(resolve, 50));
            attempts++;
          }

          if (!window.firebaseAuthReady) {
            throw new Error('Firebase failed to initialize');
          }

          // Wait for Firebase Auth to complete its initial state check or timeout
          const user = await Promise.race([window.firebaseAuthReady, firebaseTimeout]);

          if (!user) {
            // Not authenticated - redirect to login
            console.log('Not authenticated, redirecting to login');
            window.location.href = 'login.html';
            return;
          }

          // User is authenticated - load dashboard
          await loadDashboard(user);
        } catch (error) {
          console.error('Dashboard initialization error:', error);
          showErrorState(
            'Unable to load dashboard. Please check your connection and <a href="javascript:location.reload()">refresh the page</a>.'
          );
        }
      })();

      function showErrorState(message) {
        const container = document.querySelector('.dashboard-layout');
        if (container) {
          container.innerHTML = `
            <div class="activity-section" style="text-align: center; padding: 3rem;">
              <h2 style="color: #dc3545;">Error Loading Dashboard</h2>
              <p style="margin: 1rem 0;">${message}</p>
              <p style="margin-top: 2rem;">
                <a href="login.html" class="btn btn-primary">Return to Login</a>
              </p>
            </div>
          `;
        }
      }

      // ============================================
      // Time-Aware Greeting
      // ============================================

      function getTimeGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return 'Good morning';
        if (hour < 17) return 'Good afternoon';
        return 'Good evening';
      }

      // Set greeting on load
      document.getElementById('greeting-time').textContent = getTimeGreeting();

      // ============================================
      // Dashboard Loading
      // ============================================

      async function loadDashboard(user) {
        try {
          // Load profile
          const profile = await window.firestoreGetProfile(user.uid);

          if (!profile) {
            console.error('Profile not found');
            window.location.href = 'login.html';
            return;
          }

          // Display username in greeting and settings
          const username = profile.username || 'User';
          document.getElementById('username-display').textContent = username;
          document.getElementById('settings-username').textContent = username;

          if (profile) {
            // Update stats
            const comparisons = profile.profile.comparisonHistory || [];
            const tanks = profile.profile.tanks || [];
            const favorites = profile.profile.favoriteSpecies || [];

            document.getElementById('comparison-count').textContent = comparisons.length;
            document.getElementById('tank-count').textContent = tanks.length;
            document.getElementById('favorite-count').textContent = favorites.length;

            // Calculate total species across all tanks
            const totalSpecies = tanks.reduce((sum, tank) => sum + (tank.species?.length || 0), 0);
            document.getElementById('species-total-count').textContent = totalSpecies;

            // Update hero CTA based on tank count
            updateHeroCTA(tanks.length);

            // Initialize tank manager (loads full tank list)
            await window.tankManager.init();

            // Load notifications
            await loadNotifications(user.uid);

            // Update push notification UI state
            await updatePushNotificationUI();

            // Load maintenance timeline
            await loadMaintenanceTimeline();

            // Load social stats (follower/following counts)
            if (window.socialManager) {
              const [followerCount, followingCount] = await Promise.all([
                window.socialManager.getFollowerCount(user.uid),
                window.socialManager.getFollowingCount(user.uid),
              ]);
              document.getElementById('follower-count').textContent = followerCount;
              document.getElementById('following-count').textContent = followingCount;
            }
          }
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          showErrorState(
            'Failed to load your data. Please <a href="javascript:location.reload()">refresh the page</a>.'
          );
        }
      }

      function updateHeroCTA(tankCount) {
        const btn = document.getElementById('hero-cta-btn');
        if (tankCount === 0) {
          btn.textContent = '+ Create Your First Tank';
        } else {
          btn.textContent = '+ Add New Tank';
        }
      }

      // Store tanks globally for modal access
      let userTanks = [];

      async function loadMaintenanceTimeline() {
        const timelineContainer = document.getElementById('maintenance-timeline');
        const summaryEl = document.getElementById('maintenance-summary');
        const actionsSection = document.getElementById('timeline-actions');

        // Get all tanks
        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        const profile = await window.firestoreGetProfile(uid);
        userTanks = profile?.profile?.tanks || [];

        if (userTanks.length === 0) {
          timelineContainer.innerHTML = `
            <div class="maintenance-timeline-empty">
              <p>Create a tank to start tracking maintenance</p>
            </div>
          `;
          actionsSection.style.display = 'none';
          return;
        }

        // Collect all schedules across all tanks
        const allSchedules = [];
        for (const tank of userTanks) {
          try {
            const schedules = await window.firestoreGetTankSchedules?.(uid, tank.id);
            if (schedules) {
              schedules.forEach(schedule => {
                if (schedule.active !== false) {
                  allSchedules.push({
                    ...schedule,
                    tankId: tank.id,
                    tankName: tank.name,
                  });
                }
              });
            }
          } catch (e) {
            console.error('Error loading schedules for tank:', tank.id, e);
          }
        }

        if (allSchedules.length === 0) {
          timelineContainer.innerHTML = `
            <div class="maintenance-timeline-empty">
              <p>No maintenance scheduled</p>
              <p style="font-size: 0.9rem; margin-top: 0.5rem;">Add schedules to your tanks to see upcoming tasks</p>
            </div>
          `;
          summaryEl.textContent = '';
        }

        // Always show actions section if user has tanks
        actionsSection.style.display = 'flex';

        // Wire up action buttons
        document.getElementById('timeline-log-event-btn').onclick = () =>
          openEventModalWithTankSelector();
        document.getElementById('timeline-add-schedule-btn').onclick = () =>
          openScheduleModalWithTankSelector();

        if (allSchedules.length === 0) {
          return;
        }

        // Sort by due date
        allSchedules.sort((a, b) => new Date(a.nextDue) - new Date(b.nextDue));

        // Group by time period
        const today = [];
        const thisWeek = [];
        const later = [];
        const now = new Date();
        now.setHours(0, 0, 0, 0);

        allSchedules.forEach(schedule => {
          const dueDate = new Date(schedule.nextDue);
          dueDate.setHours(0, 0, 0, 0);
          const diffDays = Math.round((dueDate - now) / (1000 * 60 * 60 * 24));

          if (diffDays <= 0) {
            today.push({ ...schedule, diffDays });
          } else if (diffDays <= 7) {
            thisWeek.push({ ...schedule, diffDays });
          } else {
            later.push({ ...schedule, diffDays });
          }
        });

        // Count tasks needing attention
        const overdueCount = today.filter(s => s.diffDays < 0).length;
        const dueTodayCount = today.filter(s => s.diffDays === 0).length;
        const dueThisWeekCount = thisWeek.length;

        // Update summary
        if (overdueCount > 0) {
          summaryEl.textContent = `${overdueCount} overdue`;
          document.getElementById('dashboard-status').textContent =
            `${overdueCount} task${overdueCount > 1 ? 's need' : ' needs'} attention`;
          document.getElementById('dashboard-status').classList.add('needs-attention');
        } else if (dueTodayCount > 0) {
          summaryEl.textContent = `${dueTodayCount} due today`;
        } else if (dueThisWeekCount > 0) {
          summaryEl.textContent = `${dueThisWeekCount} this week`;
        } else {
          summaryEl.textContent = 'All clear';
          document.getElementById('dashboard-status').textContent =
            'Your aquariums are looking great';
        }

        // Build HTML
        let html = '';

        if (today.length > 0) {
          html += `<div class="timeline-group">`;
          html += `<div class="timeline-label">${overdueCount > 0 ? 'Overdue / Today' : 'Today'}</div>`;
          today.forEach(schedule => {
            html += renderMaintenanceTask(schedule);
          });
          html += `</div>`;
        }

        if (thisWeek.length > 0) {
          html += `<div class="timeline-group">`;
          html += `<div class="timeline-label">This Week</div>`;
          thisWeek.forEach(schedule => {
            html += renderMaintenanceTask(schedule);
          });
          html += `</div>`;
        }

        if (later.length > 0 && today.length + thisWeek.length < 5) {
          html += `<div class="timeline-group">`;
          html += `<div class="timeline-label">Later</div>`;
          later.slice(0, 3).forEach(schedule => {
            html += renderMaintenanceTask(schedule);
          });
          html += `</div>`;
        }

        timelineContainer.innerHTML = html;
      }

      function renderMaintenanceTask(schedule) {
        const statusClass =
          schedule.diffDays < 0
            ? 'overdue'
            : schedule.diffDays === 0
              ? 'approaching'
              : schedule.diffDays <= 3
                ? 'approaching'
                : 'relaxed';

        const typeInfo = window.maintenanceManager?.getEventTypeInfo(schedule.type) || {
          label: schedule.type,
        };

        // Prepare schedule data for edit button
        const scheduleData = JSON.stringify(schedule).replace(/"/g, '&quot;');

        return `
          <div class="maintenance-task-card">
            <div class="maintenance-status-indicator ${statusClass}"></div>
            <div class="task-info" onclick="editScheduleFromTimeline(${scheduleData})" style="cursor: pointer;" title="Click to edit or delete">
              <span class="task-name">${escapeHTML(typeInfo.label)}</span>
              <span class="task-tank">${escapeHTML(schedule.tankName)}</span>
            </div>
            <div class="task-actions">
              <button class="task-edit-btn" onclick="editScheduleFromTimeline(${scheduleData})" title="Edit schedule">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="task-complete-btn" onclick="completeScheduleFromTimeline('${schedule.id}', '${schedule.tankId}', '${schedule.type}')">
                Done
              </button>
            </div>
          </div>
        `;
      }

      function editScheduleFromTimeline(schedule) {
        window.maintenanceManager?.openScheduleModal(schedule.tankId, schedule.tankName, schedule);
      }

      async function completeScheduleFromTimeline(scheduleId, tankId, type) {
        await window.maintenanceManager?.markScheduleComplete(scheduleId, tankId, type);
        // Reload timeline
        await loadMaintenanceTimeline();
        // Refresh tank display if visible
        await window.tankManager?.loadTanks();
      }

      // Open event modal with tank selector (if multiple tanks)
      async function openEventModalWithTankSelector() {
        // Always fetch fresh tank data
        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        const profile = await window.firestoreGetProfile(uid);
        const tanks = profile?.profile?.tanks || [];

        if (tanks.length === 0) {
          alert('Create a tank first to log events');
          return;
        }

        if (tanks.length === 1) {
          // Only one tank - go directly to event modal
          window.maintenanceManager?.openEventModal(tanks[0].id, tanks[0].name);
        } else {
          // Multiple tanks - show selector modal
          showTankSelectorModal('event', tanks);
        }
      }

      // Open schedule modal with tank selector (if multiple tanks)
      async function openScheduleModalWithTankSelector() {
        // Always fetch fresh tank data
        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        const profile = await window.firestoreGetProfile(uid);
        const tanks = profile?.profile?.tanks || [];

        if (tanks.length === 0) {
          alert('Create a tank first to add schedules');
          return;
        }

        if (tanks.length === 1) {
          // Only one tank - go directly to schedule modal
          window.maintenanceManager?.openScheduleModal(tanks[0].id, tanks[0].name);
        } else {
          // Multiple tanks - show selector modal
          showTankSelectorModal('schedule', tanks);
        }
      }

      // Show tank selector modal
      function showTankSelectorModal(actionType, tanks) {
        const container = document.getElementById('event-modal-container');
        if (!container) return;

        const title = actionType === 'event' ? 'Log Event' : 'Add Schedule';

        const modal = document.createElement('div');
        modal.className = 'event-modal-overlay';
        modal.onclick = e => {
          if (e.target === modal) closeTankSelectorModal();
        };

        modal.innerHTML = `
          <div class="event-modal" style="max-width: 400px;">
            <div class="event-modal-header">
              <h3>${title}</h3>
              <button class="event-modal-close" onclick="closeTankSelectorModal()">&times;</button>
            </div>
            <div class="event-modal-body">
              <div class="form-group">
                <label>Select Tank</label>
                <div class="tank-selector-grid">
                  ${tanks
                    .map(
                      tank => `
                    <button class="tank-selector-btn" onclick="selectTankForAction('${tank.id}', '${tank.name.replace(/'/g, "\\'")}', '${actionType}')">
                      <span class="tank-selector-name">${escapeHTML(tank.name)}</span>
                      <span class="tank-selector-meta">${tank.size} gal · ${tank.species?.length || 0} species</span>
                    </button>
                  `
                    )
                    .join('')}
                </div>
              </div>
            </div>
          </div>
        `;

        container.innerHTML = '';
        container.appendChild(modal);
      }

      function closeTankSelectorModal() {
        const container = document.getElementById('event-modal-container');
        if (container) container.innerHTML = '';
      }

      function selectTankForAction(tankId, tankName, actionType) {
        closeTankSelectorModal();
        if (actionType === 'event') {
          window.maintenanceManager?.openEventModal(tankId, tankName);
        } else {
          window.maintenanceManager?.openScheduleModal(tankId, tankName);
        }
      }

      // Make functions globally available
      window.closeTankSelectorModal = closeTankSelectorModal;
      window.selectTankForAction = selectTankForAction;

      // ============================================
      // Tank Modal Functions
      // ============================================

      let currentModalTankId = null;

      function openTankModal(tankId) {
        currentModalTankId = tankId;
        window.currentModalTankId = tankId; // Expose for maintenance-manager.js
        const backdrop = document.getElementById('tank-modal-backdrop');
        backdrop.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Load tank data
        loadTankModalData(tankId);
      }

      function closeTankModal() {
        const backdrop = document.getElementById('tank-modal-backdrop');
        backdrop.classList.remove('active');
        document.body.style.overflow = '';
        currentModalTankId = null;
        window.currentModalTankId = null; // Clear for maintenance-manager.js
      }

      // Close on backdrop click
      document.getElementById('tank-modal-backdrop').addEventListener('click', function (e) {
        if (e.target === this) {
          closeTankModal();
        }
      });

      // Close on ESC
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && currentModalTankId) {
          closeTankModal();
        }
      });

      async function loadTankModalData(tankId) {
        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        const profile = await window.firestoreGetProfile(uid);
        const tank = profile?.profile?.tanks?.find(t => t.id === tankId);
        if (!tank) return;

        // Set tank info
        document.getElementById('tank-modal-name').textContent = tank.name || 'Untitled Tank';
        const metaParts = [`${tank.size} gallons`, `${tank.species?.length || 0} species`];
        if (tank.plants && tank.plants.length > 0) {
          metaParts.push(`${tank.plants.length} plants`);
        }
        document.getElementById('tank-modal-meta').textContent = metaParts.join(' · ');

        // Notes
        const notesEl = document.getElementById('tank-modal-notes');
        if (tank.notes && tank.notes.trim()) {
          notesEl.textContent = tank.notes;
          notesEl.style.display = 'block';
        } else {
          notesEl.style.display = 'none';
        }

        // Tank header image: show cover photo if available, otherwise species mosaic
        const mosaicEl = document.getElementById('tank-modal-mosaic');
        const speciesListEl = document.getElementById('tank-modal-species');

        if (tank.coverPhoto) {
          // Show user-uploaded cover photo
          mosaicEl.className = 'tank-modal-mosaic single-image';
          mosaicEl.innerHTML = `<img src="${tank.coverPhoto}" alt="${escapeHTML(tank.name || 'Tank photo')}" />`;
        } else if (tank.species && tank.species.length > 0) {
          // Fallback to species mosaic
          const images = tank.species
            .slice(0, 6)
            .map(key => fishDatabase[key]?.imageUrl)
            .filter(url => url);

          if (images.length <= 2) {
            mosaicEl.className = 'tank-modal-mosaic single-image';
            mosaicEl.innerHTML = images[0] ? `<img src="${images[0]}" alt="Tank species" />` : '';
          } else {
            mosaicEl.className = 'tank-modal-mosaic';
            mosaicEl.innerHTML = images.map(url => `<img src="${url}" alt="Species" />`).join('');
          }
        } else {
          mosaicEl.innerHTML = '<div class="tank-portrait-placeholder">No species added</div>';
        }

        // Species list (always populated if species exist)
        if (tank.species && tank.species.length > 0) {
          speciesListEl.innerHTML = tank.species
            .map(key => {
              const fish = fishDatabase[key];
              if (!fish) return '';
              return `
              <li class="tank-modal-species-item">
                ${fish.imageUrl ? `<img src="${fish.imageUrl}" alt="${escapeHTML(fish.commonName)}" />` : ''}
                <span>${escapeHTML(fish.commonName)}</span>
              </li>
            `;
            })
            .join('');
        } else {
          speciesListEl.innerHTML =
            '<li class="tank-modal-species-item"><span>No species added yet</span></li>';
        }

        // Plants list
        const plantsListEl = document.getElementById('tank-modal-plants');
        if (tank.plants && tank.plants.length > 0 && typeof plantDatabase !== 'undefined') {
          plantsListEl.innerHTML = tank.plants
            .map(key => {
              const plant = plantDatabase[key];
              if (!plant) return '';
              return `
              <li class="tank-modal-species-item">
                ${plant.imageUrl ? `<img src="${plant.imageUrl}" alt="${escapeHTML(plant.commonName)}" />` : ''}
                <span>${escapeHTML(plant.commonName)}</span>
              </li>
            `;
            })
            .join('');
        } else {
          plantsListEl.innerHTML =
            '<li class="tank-modal-species-item"><span>No plants added yet</span></li>';
        }

        // Quick log buttons
        document.getElementById('tank-modal-quicklog-buttons').innerHTML = `
          <button class="quick-log-btn" onclick="window.maintenanceManager.quickLogEvent('${tankId}', 'waterChange')">Water Change</button>
          <button class="quick-log-btn" onclick="window.maintenanceManager.quickLogEvent('${tankId}', 'parameterTest')">Parameter Test</button>
          <button class="quick-log-btn" onclick="window.maintenanceManager.quickLogEvent('${tankId}', 'filterMaintenance')">Filter</button>
        `;

        // Wire up "+ Log Event" button to open full event modal
        const logEventBtn = document.getElementById('tank-modal-log-event-btn');
        if (logEventBtn) {
          logEventBtn.onclick = () => {
            window.maintenanceManager?.openEventModal(tankId, tank.name);
          };
        }

        // Wire up "+ Add Schedule" button to open schedule modal
        const addScheduleBtn = document.getElementById('tank-modal-add-schedule-btn');
        if (addScheduleBtn) {
          addScheduleBtn.onclick = () => {
            window.maintenanceManager?.openScheduleModal(tankId, tank.name);
          };
        }

        // Load schedules (clickable to edit/delete)
        const schedulesEl = document.getElementById('tank-modal-schedules');
        try {
          const schedules = await window.firestoreGetTankSchedules?.(uid, tankId);
          if (schedules && schedules.length > 0) {
            schedulesEl.innerHTML = schedules
              .map(s => {
                const typeInfo = window.maintenanceManager?.getEventTypeInfo(s.type) || {
                  label: s.type,
                };
                const due = window.maintenanceManager?.formatDueDate(s.nextDue) || {
                  text: 'Unknown',
                  class: '',
                };
                // Store schedule data for click handler
                const scheduleData = JSON.stringify(s).replace(/"/g, '&quot;');
                return `
                <div class="schedule-pill clickable ${due.class}"
                     onclick="openScheduleForEdit('${tankId}', '${tank.name.replace(/'/g, "\\'")}', ${scheduleData})"
                     title="Click to edit or delete">
                  <span class="schedule-name">${escapeHTML(typeInfo.label)}</span>
                  <span class="schedule-due">${due.text}</span>
                </div>
              `;
              })
              .join('');
          } else {
            schedulesEl.innerHTML =
              '<p style="color: var(--ink-tertiary); font-size: 0.9rem;">No schedules set</p>';
          }
        } catch (e) {
          schedulesEl.innerHTML =
            '<p style="color: var(--ink-tertiary);">Unable to load schedules</p>';
        }

        // Load events (with delete buttons)
        const eventsEl = document.getElementById('tank-modal-events');
        try {
          const events = await window.firestoreGetTankEvents?.(uid, tankId, 5);
          if (events && events.length > 0) {
            eventsEl.innerHTML = events
              .map(e => {
                const typeInfo = window.maintenanceManager?.getEventTypeInfo(e.type) || {
                  label: e.type,
                };
                const dateStr = window.maintenanceManager?.formatDate(e.date) || 'Unknown';

                // Build event label - show species name for fish added/removed events
                let eventLabel = typeInfo.label;
                if ((e.type === 'fishAdded' || e.type === 'fishRemoved') && e.data?.speciesKey) {
                  const fish = fishDatabase[e.data.speciesKey];
                  if (fish) {
                    const qty = e.data.quantity || 1;
                    const action = e.type === 'fishAdded' ? 'Added' : 'Removed';
                    eventLabel = `${action} ${qty}x ${fish.commonName}`;
                  }
                }

                return `
                <div class="event-item">
                  <div class="event-info">
                    <span class="event-type">${escapeHTML(eventLabel)}</span>
                    <span class="event-date">${dateStr}</span>
                    ${e.notes ? `<span class="event-notes">${escapeHTML(e.notes)}</span>` : ''}
                  </div>
                  <button class="event-delete-btn" onclick="deleteEventFromModal('${e.id}', '${tankId}')" title="Delete event">&times;</button>
                </div>
              `;
              })
              .join('');
          } else {
            eventsEl.innerHTML =
              '<p style="color: var(--ink-tertiary); font-size: 0.9rem;">No recent activity</p>';
          }
        } catch (e) {
          eventsEl.innerHTML = '<p style="color: var(--ink-tertiary);">Unable to load events</p>';
        }

        // Edit/Delete buttons
        document.getElementById('tank-modal-edit-btn').onclick = () => {
          closeTankModal();
          window.tankManager.editTank(tankId);
        };
        document.getElementById('tank-modal-delete-btn').onclick = () => {
          closeTankModal();
          window.tankManager.deleteTank(tankId);
        };
      }

      // Open schedule for editing (from tank modal)
      function openScheduleForEdit(tankId, tankName, scheduleData) {
        window.maintenanceManager?.openScheduleModal(tankId, tankName, scheduleData);
      }

      // Delete event from tank modal
      async function deleteEventFromModal(eventId, tankId) {
        if (!confirm('Delete this event?')) return;

        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        try {
          const result = await window.firestoreDeleteTankEvent(uid, eventId);
          if (result.success) {
            authManager?.showMessage?.('Event deleted', 'success');
            // Refresh the tank modal to show updated events
            await loadTankModalData(tankId);
            // Also refresh the timeline
            await loadMaintenanceTimeline();
          }
        } catch (e) {
          console.error('Error deleting event:', e);
          authManager?.showMessage?.('Failed to delete event', 'error');
        }
      }

      // Make functions globally available
      window.openTankModal = openTankModal;
      window.closeTankModal = closeTankModal;
      window.loadTankModalData = loadTankModalData;
      window.loadMaintenanceTimeline = loadMaintenanceTimeline;
      window.openScheduleForEdit = openScheduleForEdit;
      window.deleteEventFromModal = deleteEventFromModal;

      // ============================================
      // Notification Functions
      // ============================================

      async function loadNotifications(uid) {
        if (!window.firestoreGetNotifications) {
          console.warn('firestoreGetNotifications not available');
          return;
        }
        const notifications = await window.firestoreGetNotifications(uid);
        renderNotifications(notifications);
      }

      async function handleNotificationClick(notificationId, actionUrl) {
        // Mark as read
        if (window.firestoreMarkNotificationRead) {
          await window.firestoreMarkNotificationRead(notificationId);
        }
        // Navigate to action URL (only if non-empty)
        if (actionUrl && actionUrl.trim() !== '') {
          window.location.href = actionUrl;
        }
      }

      // ============================================
      // Dropdown Functions (Notifications & Settings)
      // ============================================

      function toggleNotifications() {
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');
        // Close settings if open
        settingsDropdown.classList.remove('open');
        // Toggle notifications
        notifDropdown.classList.toggle('open');
      }

      function toggleSettings() {
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');
        // Close notifications if open
        notifDropdown.classList.remove('open');
        // Toggle settings
        settingsDropdown.classList.toggle('open');
      }

      function viewMyProfile() {
        const username = document.getElementById('settings-username')?.textContent;
        if (username) {
          window.location.href = `profile.html?user=${encodeURIComponent(username)}`;
        }
      }

      async function markAllRead() {
        const uid = window.getFirebaseUid?.();
        if (!uid) return;

        // Get all unread notifications and mark them read
        const notifications = await window.firestoreGetNotifications?.(uid);
        const unread = notifications?.filter(n => !n.read) || [];

        if (unread.length === 0) {
          // No unread notifications, just close dropdown
          document.getElementById('notification-dropdown').classList.remove('open');
          return;
        }

        // Mark all unread notifications as read in parallel
        try {
          await Promise.all(unread.map(n => window.firestoreMarkNotificationRead?.(n.id)));
        } catch (error) {
          console.error('Failed to mark some notifications as read:', error);
          // Continue anyway - partial success is better than blocking UI
        }

        // Refresh the notification list
        await loadNotifications(uid);

        // Close dropdown
        document.getElementById('notification-dropdown').classList.remove('open');
      }

      // ============================================
      // Push Notification Functions
      // ============================================

      /**
       * Toggle push notifications on/off
       */
      async function togglePushNotifications() {
        const btn = document.getElementById('push-toggle-btn');
        const uid = window.getFirebaseUid?.();

        if (!uid) {
          console.warn('User not logged in');
          return;
        }

        // Check current state
        const isEnabled = await window.fcmIsEnabled?.(uid);

        if (isEnabled) {
          // Disable notifications
          btn.textContent = 'Disabling...';
          btn.disabled = true;

          const success = await window.fcmDisableNotifications?.(uid);
          if (success) {
            btn.textContent = 'Enable';
            btn.classList.remove('active');
          } else {
            btn.textContent = 'Disable';
            console.error('Failed to disable push notifications');
          }
          btn.disabled = false;
        } else {
          // Enable notifications
          btn.textContent = 'Enabling...';
          btn.disabled = true;

          const result = await window.fcmRequestPermission?.(uid);
          if (result?.success) {
            btn.textContent = 'Disable';
            btn.classList.add('active');
            // Foreground handler is set up in updatePushNotificationUI
          } else {
            btn.textContent = 'Enable';
            if (result?.error) {
              alert(result.error);
            }
          }
          btn.disabled = false;
        }
      }

      /**
       * Update push notification button state based on current permission
       */
      async function updatePushNotificationUI() {
        const btn = document.getElementById('push-toggle-btn');
        const setting = document.getElementById('push-notification-setting');
        const uid = window.getFirebaseUid?.();

        if (!btn || !setting) return;

        // Check if FCM is supported or user not logged in
        if (!window.fcmIsEnabled || !uid) {
          // FCM not available or not logged in, hide the setting
          setting.style.display = 'none';
          return;
        }

        // Check current state
        const isEnabled = await window.fcmIsEnabled(uid);
        if (isEnabled) {
          btn.textContent = 'Disable';
          btn.classList.add('active');

          // Set up foreground handler for enabled users
          window.fcmSetupForegroundHandler?.(() => {
            loadNotifications(uid);
          });
        } else {
          btn.textContent = 'Enable';
          btn.classList.remove('active');
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function (event) {
        const notifWrapper = document.querySelector('.notification-wrapper');
        const settingsWrapper = document.querySelector('.settings-wrapper');
        const notifDropdown = document.getElementById('notification-dropdown');
        const settingsDropdown = document.getElementById('settings-dropdown');

        // Close notification dropdown if clicking outside
        if (notifWrapper && notifDropdown && !notifWrapper.contains(event.target)) {
          notifDropdown.classList.remove('open');
        }

        // Close settings dropdown if clicking outside
        if (settingsWrapper && settingsDropdown && !settingsWrapper.contains(event.target)) {
          settingsDropdown.classList.remove('open');
        }
      });

      // Update notification badge count
      function updateNotificationBadge(count) {
        const badge = document.getElementById('notification-badge');
        if (badge) {
          badge.textContent = count;
          badge.setAttribute('data-count', count);
          badge.style.display = count > 0 ? 'flex' : 'none';
        }
      }

      // Escape HTML to prevent XSS (user content like tankName flows through notifications)
      function escapeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // Render notifications list
      function renderNotifications(notifications) {
        const list = document.getElementById('notification-list');

        if (!notifications || notifications.length === 0) {
          list.innerHTML = `
            <div class="notification-empty">
              <p>No notifications yet</p>
              <small>Maintenance reminders will appear here</small>
            </div>
          `;
          updateNotificationBadge(0);
          return;
        }

        const unreadCount = notifications.filter(n => !n.read).length;
        updateNotificationBadge(unreadCount);

        list.innerHTML = notifications
          .map(
            n => `
          <div class="notification-item ${n.read ? '' : 'unread'}"
               data-id="${escapeHTML(n.id)}"
               data-action-url="${escapeHTML(n.action?.url || '')}"
               style="cursor: pointer;">
            <div class="notification-item-title">${escapeHTML(n.title)}</div>
            <div class="notification-item-body">${escapeHTML(n.body)}</div>
            <div class="notification-item-time">${formatTimeAgo(n.created)}</div>
          </div>
        `
          )
          .join('');

        // Add click handlers using event delegation
        list.querySelectorAll('.notification-item[data-id]').forEach(item => {
          item.addEventListener('click', () => {
            const id = item.getAttribute('data-id');
            const url = item.getAttribute('data-action-url');
            handleNotificationClick(id, url);
          });
        });
      }

      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Badge starts hidden, updated when notifications load
      updateNotificationBadge(0);
    </script>
    <script src="js/scroll-animations.js"></script>
  </body>
</html>
